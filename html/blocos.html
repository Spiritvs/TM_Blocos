<!DOCTYPE html>
<html>
	<title>XtrmPixel</title>
	<head>
		<link href="style.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="/jquery/jquery.min.js"></script>
		<script type="text/javascript" src="/jquery/jquery.mobile.min.js"></script>
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>	
	</head>
	<body onload="init()">
		<canvas id="myCanvas" width="1000" height="600"></canvas>
		<div id="texto" width="500" height="30"></div>
		<div id="count">
			<h2>i have an id : <span id="myid"></span></h2>
			<h2>number of connections : <span id="ncc"></span></h2>
		</div>
		<div id=log>

		</div>
	</body>
	<script>
		$(document).ready(function() {
			var myID = -1;

			// socket object : tries to connect
			// the default connect sends a message 'connection'
			var socket = io.connect();

			console.log('connecting...');

			// when a socket successfully connects to a server
			// it receives a connect message ackkowledging the
			// connection
			socket.on("connect", function(data) {
				$("#log").append("connection established");
				$(document).click(clickHandler);
			});

			socket.on('count', function(data) {
				$("#ncc").html(data.count);
			});

			socket.on('logged', function(data) {
				console.log("have an id");
				//myColor = data.color;
				myID = data.id;
				$("#myid").html(myID);
			});

			socket.on("click", function(data) {
				$("#log").append(data.id + " clicou em x:" + data.x + " y:" + data.y + "<br/>");
			});

			function clickHandler(event) {
				myX = event.pageX;
				myY = event.pageY;
				socket.emit('click', {
					"id" : myID,
					"x" : myX,
					"y" : myY
				});
			}

		});
	</script>

	<script>
		var xMax = 40;
		var yMax = 24;
		var larg = 25;
		var f = new Array();
		var boxes = new Array();
		var c = document.getElementById("myCanvas");
		var ctx = c.getContext("2d");
		window.addEventListener('keydown', keyP, false);
		var txt = document.getElementById("texto");

		function init() {
			geraArray();
			addRect(0, 5, 5, larg, larg, "green");
			addRect(1, 10, 10, larg, larg, "red");
			tx();
		}

		function geraArray() {
			for (var x = 0; x < xMax; x++) {
				f[x] = new Array();
				for (var y = 0; y < yMax; y++) {
					f[x][y] = 0;
					//alert(f[x][y]);
				}
			}
		}

		function tx() {
			f.toString();
			txt.innerHTML = f;
		}

		function addRect(id, x, y, w, h, fill) {
			var rect = new Box(id, x, y, w, h, fill);
			boxes.push(rect);
			geraQuad(x, y, w, h, fill);
		}

		function Box(id, x, y, w, h, fill) {
			this.id = id;
			this.x = x;
			this.y = y;
			this.w = w;
			this.h = h;
			this.fill = fill;
		}

		function geraQuad(x, y, w, h, fill) {
			f[x][y] = 1;
			//alert(f[x][y]);
			x = x * larg;
			y = y * larg;
			ctx.fillStyle = fill;
			ctx.fillRect(x, y, w, h);
		};

		function clearCanvas(x, y, w, h) {
			f[x][y] = 0;
			//c.width = c.width;
			x = x * larg;
			y = y * larg;
			ctx.clearRect(x, y, larg, larg);
		}

		// {"comando":"up","id",3}
		function mKeyP(msg) {
			clearCanvas(boxes[msg.id].x, boxes[msg.id].y, boxes[msg.id].w, boxes[msg.id].h);
			switch(msg.comando) {
				case"up":
					if (boxes[msg.id].y > 0) {
						if (f[boxes[msg.id].x][boxes[msg.id].y - 1] == 0) {
							boxes[msg.id].y--;
						}
					}
					break;
				case"left":
					if (boxes[msg.id].x > 0) {
						if (f[boxes[msg.id].x - 1][boxes[msg.id].y] == 0) {
							boxes[msg.id].x--;
						}
					}
					break;
				case"down":
					if (boxes[msg.id].y < yMax) {
						if (f[boxes[msg.id].x][boxes[msg.id].y + 1] == 0) {
							boxes[msg.id].y++;
						}
					}
					break;
				case"right":
					if (boxes[msg.id].x < xMax - 1) {
						if (f[boxes[msg.id].x + 1][boxes[msg.id].y] == 0) {
							boxes[msg.id].x++;
						}
					}
					break;
			}
			geraQuad(boxes[msg.id].x, boxes[msg.id].y, boxes[msg.id].w, boxes[msg.id].h, boxes[msg.id].fill);
			tx();
		}

		function keyP(e) {
			//alert(e.keyCode);
			var id;
			var comando;
			var aux = 0;
			switch(e.keyCode) {
				case 83:
					id = 0;
					comando = "down";
					break;
				case 87:
					id = 0;
					comando = "up";
					break;
				case 68:
					id = 0;
					comando = "right";
					break;
				case 65:
					id = 0;
					comando = "left";
					break;
				case 75:
					id = 1;
					comando = "down";
					break;
				case 73:
					id = 1;
					comando = "up";
					break;
				case 76:
					id = 1;
					comando = "right";
					break;
				case 74:
					id = 1;
					comando = "left";
					break;
			}
			msg = {
				"comando" : comando,
				"id" : id
			};
			mKeyP(msg);
		};
	</script>
</html>